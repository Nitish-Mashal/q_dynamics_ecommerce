<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

<section class="container my-5" id="products-by-tag-section">

  <!-- Heading -->
  <div class="position-relative mb-3">
    <h4 class="mb-0 text-center">Products</h4>
    <a href="/all-products"
       class="position-absolute top-50 end-0 translate-middle-y text-decoration-none text-black small">
      View All
    </a>
  </div>

  <!-- TAG BUTTONS -->
  <div class="d-flex justify-content-center gap-2 mb-4 flex-wrap" id="tag-buttons"></div>

  <!-- PRODUCT WRAPPER -->
  <div class="product-wrapper">

    <button class="product-btn prev">â€¹</button>

    <div class="product-scroll" id="product-scroll"></div>

    <button class="product-btn next">â€º</button>

  </div>
</section>

<style>
.product-wrapper {
  position: relative;
  display: flex;
  align-items: center;
}

.product-scroll {
  display: flex;
  gap: 16px;
  overflow-x: hidden;
  padding: 10px 50px;
  scroll-behavior: smooth;
}

.product-card {
  flex: 0 0 auto;
  width: 260px;
}

.product-img {
  max-height: 180px;
  object-fit: contain;
}

/* Arrow buttons */
.product-btn {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(0,0,0,0.15);
  color: #fff;
  border: none;
  width: 42px;
  height: 42px;
  border-radius: 50%;
  font-size: 26px;
  cursor: pointer;
  z-index: 5;
}

.product-btn.prev { left: 0; }
.product-btn.next { right: 0; }
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {

  const section = document.getElementById("products-by-tag-section");
  const productScroll = document.getElementById("product-scroll");
  const tagButtons = document.getElementById("tag-buttons");
  const prevBtn = document.querySelector(".product-btn.prev");
  const nextBtn = document.querySelector(".product-btn.next");

  const CARD_WIDTH = 276;
  let autoScrollTimer = null;
  let isPaused = false;

  /* ===============================
     AUTO SCROLL
  =============================== */
  function startAutoScroll() {
    stopAutoScroll();
    autoScrollTimer = setInterval(() => {
      if (isPaused || !productScroll.children.length) return;

      const maxScroll =
        productScroll.scrollWidth - productScroll.clientWidth;

      if (productScroll.scrollLeft >= maxScroll - 5) {
        productScroll.scrollTo({ left: 0, behavior: "smooth" });
      } else {
        productScroll.scrollBy({ left: CARD_WIDTH, behavior: "smooth" });
      }
    }, 3000);
  }

  function stopAutoScroll() {
    if (autoScrollTimer) clearInterval(autoScrollTimer);
  }

  function pauseAutoScroll() {
    isPaused = true;
    setTimeout(() => (isPaused = false), 3000);
  }

  /* ===============================
     RENDER PRODUCTS
  =============================== */
  function renderProducts(products) {
    productScroll.innerHTML = "";

    if (!products || !products.length) {
      productScroll.innerHTML = `
        <p class="text-muted text-center w-100">
          No products found
        </p>`;
      stopAutoScroll();
      return;
    }

    products.forEach(item => {
      productScroll.insertAdjacentHTML("beforeend", `
        <div class="product-card">
          <a href="${item.route}" class="text-decoration-none text-dark d-block h-100">
            <div class="card h-100 border rounded-4 shadow-sm p-3">

              <div class="fw-semibold text-center mb-1">
                ${item.item_name}
              </div>

              <div class="d-flex justify-content-center gap-1 mb-2">
                <i class="bi bi-star-fill text-warning"></i>
                <i class="bi bi-star-fill text-warning"></i>
                <i class="bi bi-star-fill text-warning"></i>
                <i class="bi bi-star-fill text-warning"></i>
                <i class="bi bi-star text-warning"></i>
                <small class="text-muted ms-1">(7)</small>
              </div>

              <div class="d-flex justify-content-center mb-3">
                <img src="${item.image}" class="img-fluid product-img">
              </div>

              <p class="fw-bold text-center mb-1">
                â‚¹ ${item.standard_rate}
              </p>

              <p class="text-muted text-center small mb-0">
                93 Purchases
              </p>

            </div>
          </a>
        </div>
      `);
    });

    productScroll.scrollLeft = 0;
    startAutoScroll();   // ðŸ”¥ restart auto-scroll after render
  }

  /* ===============================
     LOAD PRODUCTS
  =============================== */
  function loadProducts(tag) {
    stopAutoScroll();
    frappe.call({
      method: "q_dynamics_ecommerce.api.products.get_products_by_tag",
      args: { tag },
      callback: r => {
        renderProducts(r.message || []);
      }
    });
  }

  /* ===============================
     LOAD TAGS
  =============================== */
  frappe.call({
    method: "q_dynamics_ecommerce.api.products.get_product_tags",
    callback: r => {

      if (!r.message || !r.message.length) {
        section.style.display = "none";
        return;
      }

      section.style.display = "block";

      r.message.forEach((t, index) => {
        const btn = document.createElement("button");
        btn.className = `btn btn-sm ${index === 0 ? 'btn-dark' : 'btn-outline-dark'}`;
        btn.innerText = t.tag;

        btn.onclick = () => {
          document
            .querySelectorAll("#tag-buttons button")
            .forEach(b => b.classList.replace("btn-dark", "btn-outline-dark"));

          btn.classList.replace("btn-outline-dark", "btn-dark");
          loadProducts(t.tag);
          pauseAutoScroll();
        };

        tagButtons.appendChild(btn);

        if (index === 0) loadProducts(t.tag);
      });
    }
  });

  /* ===============================
     ARROWS (NOW WORKING)
  =============================== */
  nextBtn.addEventListener("click", () => {
    productScroll.scrollBy({ left: CARD_WIDTH, behavior: "smooth" });
    pauseAutoScroll();
  });

  prevBtn.addEventListener("click", () => {
    productScroll.scrollBy({ left: -CARD_WIDTH, behavior: "smooth" });
    pauseAutoScroll();
  });

});
</script>
